<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>ë„ì „ê²€ ë„êµ¬ ëª¨ìŒ</title>

<style>
    body{
        font-family: Arial, sans-serif;
        background:#eef2ff;
        padding:30px;
        transition: background 0.3s, color 0.3s;
    }
    body.dark-mode{
        background:#111827;
        color:#e5e7eb;
    }

    .container{
        width:1250px;
        margin:auto;
        position:relative;
    }

    .card{
        background:#fff;
        border-radius:14px;
        padding:20px;
        margin-bottom:25px;
        box-shadow:0 4px 10px rgba(0,0,0,0.15);
        transition: background 0.3s;
    }
    body.dark-mode .card{
        background:#1f2937;
    }

    h2{ text-align:center; margin-bottom:15px; }

    input, select{
        width:100%;
        padding:9px;
        border-radius:8px;
        border:1px solid #bbb;
        margin-top:5px;
        box-sizing:border-box;
    }
    body.dark-mode input, body.dark-mode select{
        background:#374151;
        color:white;
        border:1px solid #555;
    }

    .card button{
        width:100%;
        padding:12px;
        margin-top:12px;
        background:#4A6CFF;
        color:white;
        border:none;
        border-radius:8px;
        font-size:16px;
        cursor:pointer;
    }
    .card button:hover{ background:#3a55d8; }

    .r{
        margin-top:15px;
        background:#f3f6ff;
        padding:15px;
        border-radius:12px;
        /* ê²°ê³¼ ì˜ì—­ ì „ì²´ë¥¼ í•œ ë²ˆì— ë³´ê¸° ìœ„í•´ ìŠ¤í¬ë¡¤ ì œê±° */
        max-height:none;
        overflow-y:visible;
        line-height:1.6;
    }
    body.dark-mode .r{
        background:#1e293b;
        color:#e5e7eb;
    }

    /* ìŠ¤íƒ¯ ê³„ì‚°ê¸° ê·¸ë¦¬ë“œ */
    .stat-grid{
        display:grid;
        grid-template-columns:1fr 1fr;
        gap:12px;
    }

    /* ë…¸ë€ í•˜ì´ë¼ì´íŠ¸ (ë‹¤í¬ëª¨ë“œ ëŒ€ë¹„ ìˆ˜ì •ë³¸) */
    .yellow-highlight{
        background:#ffeb3b;
        color:#111827; /* ì–´ë‘ìš´ ê¸€ììƒ‰ìœ¼ë¡œ ë³€ê²½ â†’ ë‹¤í¬ëª¨ë“œì—ì„œë„ ì˜ ë³´ì„ */
        padding:0 4px;
        border-radius:4px;
    }

    /* ë‹¤í¬ëª¨ë“œ ìŠ¤ìœ„ì¹˜ */
    .dm-switch{
        position:absolute;
        top:10px;
        right:20px;
        padding:6px 10px;
        background:#4A6CFF;
        color:white;
        border:none;
        border-radius:6px;
        cursor:pointer;
        z-index:10;
        width:auto;
        font-size:13px;
    }      cursor:pointer;
        z-index:999;
    }

    /* ë ˆíŠ¸ë¡œ(ë°”ëŒì˜ê²€ ê°ì„±) í…Œë§ˆ */
    .retro-switch{
        position:absolute;
        top:10px;
        right:110px;
        padding:6px 10px;
        background:#8b5a2b;
        color:#f9f5e7;
        border:1px solid #d2b48c;
        border-radius:6px;
        cursor:pointer;
        z-index:10;
        width:auto;
        font-size:13px;
    }
        font-family: "Malgun Gothic", "êµ´ë¦¼", system-ui, sans-serif;
        font-size:13px;
        box-shadow:0 0 0 2px rgba(0,0,0,0.15);
    }
    .retro-switch:hover{
        background:#a66a33;
    }

    body.retro-theme{
        background:url('retro_wall.png') repeat;
        color:#f9f5e7;
    }
    body.retro-theme .container{
        background:rgba(15, 10, 6, 0.92);
        border-radius:12px;
        box-shadow:0 0 0 2px #3b2614;
        padding-bottom:24px;
    }
    body.retro-theme .card{
        background:url('retro_wood_panel.png') repeat;
        border-radius:0;
        border:2px solid #c49a6c;
        box-shadow:inset 0 0 0 1px #000;
    }
    body.retro-theme h2{
        color:#ffe4b5;
        text-shadow:1px 1px 0 #000;
        border-bottom:1px solid #c49a6c;
        padding-bottom:4px;
        margin-bottom:8px;
    }
    body.retro-theme label{
        color:#f3e2c0;
    }
    body.retro-theme input,
    body.retro-theme select{
        background:#2b1a10;
        border:1px solid #c49a6c;
        color:#f9f5e7;
    }
    body.retro-theme .r{
        background:#2b1a10;
        color:#f9f5e7;
    }
    body.retro-theme .card button{
        background:url('retro_button_hex.png') no-repeat center center;
        background-size:contain;
        height:60px;
        padding:0 24px;
        color:#f4e0a8;
        border:none;
        border-radius:0;
        box-shadow:0 2px 0 #5d3b1a, 0 3px 4px rgba(0,0,0,0.4);
        font-weight:600;
        text-shadow:1px 1px 0 #3b2614;
    }
    body.retro-theme .card button:hover{
        filter:brightness(1.05);
    }
    body.retro-theme .card button:active{
        transform:translateY(1px);
        box-shadow:0 1px 0 #5d3b1a, 0 2px 3px rgba(0,0,0,0.4);
    }

body.retro-theme .dm-switch,
body.retro-theme .retro-switch{
    background:#8b5a2b;
    color:#f9f5e7;
    border:1px solid #d2b48c;
}
</style>
</head>
<body>

<button class="dm-switch" onclick="toggleDarkMode()">ë‹¤í¬ ëª¨ë“œ</button>
<button class="retro-switch" onclick="toggleRetroTheme()">ë ˆíŠ¸ë¡œ í…Œë§ˆ</button>

<div class="container">

    <!-- ê²½í—˜ì¹˜ ê³„ì‚°ê¸° -->
    <div class="card">
        <h2>ê²½í—˜ì¹˜ ê³„ì‚°ê¸°</h2>

        <label>â‘  ëª¬ìŠ¤í„° ê²½í—˜ì¹˜ ì„ íƒ</label>
        <select id="exp_mon">
            <option value="6000">6000</option>
            <option value="9000">9000</option>
            <option value="12000">12000</option>
            <option value="15000">15000</option>
        </select>

        <label>â‘¡ ë°©íŒ¨ ê°•í™” ë‹¨ê³„ (5ê°•ë¶€í„° ê²½í—˜ì¹˜ ì¦ê°€)</label>
        <select id="exp_shield">
            <option value="0">--- ì„ íƒ ---</option>
            <option value="5">5ê°• (10%)</option>
            <option value="6">6ê°• (20%)</option>
            <option value="7">7ê°• (30%)</option>
            <option value="8">8ê°• (40%)</option>
            <option value="9">9ê°• (50%)</option>
            <option value="10">10ê°• (60%)</option>
        </select>

        <button onclick="expCalc()">ê³„ì‚°í•˜ê¸°</button>

        <div class="r" id="exp_result"></div>
    </div>



    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!-- ìƒì ì‹œë®¬ë ˆì´í„° -->
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="card">
        <h2>ìƒì ì‹œë®¬ë ˆì´í„° (ë¬´ê¸° / ë°©ì–´êµ¬ / ì¥ì‹ êµ¬)</h2>

        <div style="display:flex; gap:20px;">

            <!-- LEFT: ëˆ„ì  ê²°ê³¼ -->
            <div style="flex:1;">
                <label>ëˆ„ì  ê²°ê³¼</label>
                <div class="r" id="box_accum">ì•„ì§ ì—†ìŒ</div>
                <button onclick="resetBoxAccum()">ëˆ„ì  ì´ˆê¸°í™”</button>
            </div>

            <!-- MID: UI -->
            <div style="flex:1;">
                <label>ë¶€ìœ„ ì„ íƒ</label>
                <select id="box_part" onchange="updateBoxProb()">
                    <option value="weapon">ë¬´ê¸°</option>
                    <option value="armor">ë°©ì–´êµ¬</option>
                    <option value="accessory">ì¥ì‹ êµ¬</option>
                </select>

                <label>ë“±ê¸‰ ì„ íƒ</label>
                <select id="box_grade" onchange="updateBoxProb()">
                    <option value="D">D ë“±ê¸‰ ë°•ìŠ¤</option>
                    <option value="C">C ë“±ê¸‰ ë°•ìŠ¤</option>
                    <option value="B">B ë“±ê¸‰ ë°•ìŠ¤</option>
                    <option value="A">A ë“±ê¸‰ ë°•ìŠ¤</option>
                </select>

                <button onclick="openBox(1)">1íšŒ</button>
                <button onclick="openBox(10)">10íšŒ</button>
                <button onclick="openBox(100)">100íšŒ</button>

                <div class="r" id="box_result"></div>
            </div>

            <!-- RIGHT: í™•ë¥ í‘œ -->
            <div style="flex:1;">
                <div class="r" id="box_prob"></div>
            </div>
        </div>
    </div>



    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!-- ì¥ë¹„ ê°•í™” ì‹œë®¬ë ˆì´í„° -->
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="card">
        <h2>ì¥ë¹„ ê°•í™” ì‹œë®¬ë ˆì´í„°</h2>

        <div style="display:flex; gap:20px;">

            <!-- LEFT: í†µê³„ -->
            <div style="flex:1;">
                <label>í†µê³„</label>
                <div class="r" id="upg_stats"></div>
                <button onclick="resetUpgrade()">ì´ˆê¸°í™”</button>
            </div>

            <!-- MID: ê°•í™” UI -->
            <div style="flex:1;">
                <label>ì¥ë¹„ ì¢…ë¥˜</label>
                <select id="upg_type">
                    <option value="weapon">ë¬´ê¸° (ìµœëŒ€ 15ê°•)</option>
                    <option value="armor">ë°©ì–´êµ¬ (ìµœëŒ€ 10ê°•)</option>
                    <option value="accessory">ì¥ì‹ êµ¬ (ìµœëŒ€ 8ê°•)</option>
                </select>

                <label>í˜„ì¬ ê°•í™” ë‹¨ê³„</label>
                <select id="upg_now"></select>

                <label>ëª©í‘œ ê°•í™” ë‹¨ê³„</label>
                <select id="upg_target"></select>

                <label>ì—°ì† ê°•í™”</label>
                <select id="upg_speed">
                    <option value="1">ë³´í†µ ì†ë„</option>
                    <option value="2">ë¹ ë¦„ (2ë°°)</option>
                    <option value="4">ë§¤ìš° ë¹ ë¦„ (4ë°°)</option>
                    <option value="8">ê´‘ì† (8ë°°)</option>
                </select>

                <button onclick="startUpgrade()">ê°•í™” ì‹œì‘</button>
                <button onclick="stopUpgrade()">ê°•í™” ì¤‘ì§€</button>

                <div class="r" id="upg_log"></div>
            </div>

            <!-- RIGHT: í™•ë¥ í‘œ -->
            <div style="flex:1;">
                <label>ê°•í™” í™•ë¥ </label>
                <div class="r" id="upg_prob"></div>
            </div>
        </div>
    </div>



    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <!-- ìƒì + ê°•í™” ì¢…í•© ì‹œë®¬ë ˆì´í„° (ë² íƒ€) -->
    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="card">
        <h2>ìƒì + ê°•í™” ì¢…í•© ì‹œë®¬ë ˆì´í„° (ë² íƒ€)</h2>
        <p style="font-size:13px; margin-bottom:8px;">
            íŠ¹ì • ì¥ë¹„ë¥¼ <b>ìƒìì—ì„œ ë½‘ê³ </b>, ëª©í‘œ ê°•í™”ê¹Œì§€ ì˜¬ë¦´ ë•Œê¹Œì§€ ë“œëŠ”
            <b>í‰ê·  ìƒì ê°œìˆ˜ / ì£¼ë¬¸ì„œ ê°œìˆ˜ / ë¹„ìš©</b>ì„ ëŒ€ëµì ìœ¼ë¡œ ì‹œë®¬ë ˆì´ì…˜í•©ë‹ˆë‹¤.
        </p>

        <div style="display:flex; flex-wrap:wrap; gap:16px; align-items:flex-end;">
            <div>
                <label>ì¥ë¹„ ì¢…ë¥˜</label><br>
                <select id="tc_part">
                    <option value="weapon">ë¬´ê¸°</option>
                    <option value="armor">ë°©ì–´êµ¬</option>
                    <option value="accessory">ì¥ì‹ êµ¬</option>
                </select>
            </div>

            <div>
                <label>ë…¸ë¦¬ëŠ” ë“±ê¸‰</label><br>
                <select id="tc_tier">
                    <option value="X">X</option>
                    <option value="X+">X+</option>
                </select>
                <div style="font-size:11px; color:#6b7280;">
                    ë¬´ê¸°ê°€ ì•„ë‹ ë•ŒëŠ” ìë™ìœ¼ë¡œ Xë§Œ ì‚¬ìš©ë©ë‹ˆë‹¤.
                </div>
            </div>

            <div>
                <label>ìƒì ë“±ê¸‰</label><br>
                <select id="tc_boxGrade">
                    <option value="C">C ìƒì (20ë§Œ ê³¨ë“œ)</option>
                    <option value="A">A ìƒì (3900 ë‹¤ì´ì•„)</option>
                </select>
            </div>

            <div>
                <label>ëª©í‘œ ê°•í™” ë‹¨ê³„</label><br>
                <select id="tc_targetLv">
                    <option value="5">+5</option>
                    <option value="6">+6</option>
                    <option value="7">+7</option>
                    <option value="8">+8</option>
                    <option value="9">+9</option>
                    <option value="10" selected>+10</option>
                    <option value="11">+11</option>
                    <option value="12">+12</option>
                    <option value="13">+13</option>
                    <option value="14">+14</option>
                    <option value="15">+15</option>
                </select>
            </div>

            <div>
                <label>ì‹œë®¬ë ˆì´ì…˜ íšŸìˆ˜</label><br>
                <input type="number" id="tc_runs" value="500" min="10" max="5000" step="10" style="width:90px;">
                <div style="font-size:11px; color:#6b7280;">ê°’ì´ í´ìˆ˜ë¡ í‰ê· ì´ ì•ˆì •ì ì…ë‹ˆë‹¤.</div>
            </div>

            <div>
                <button onclick="runTotalCostSim()">ì¢…í•© ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰</button>
            </div>
        </div>

        <div class="r" id="tc_result" style="margin-top:12px;">
            ì•„ì§ ì‹œë®¬ë ˆì´ì…˜ì„ ì‹¤í–‰í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.
        </div>
    </div>

    <!-- â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
    <div class="card stat-card">
        <h2>ìŠ¤íƒ¯ íš¨ìœ¨ ê³„ì‚°ê¸° (ë”œ + íšŒí”¼ ê· í˜•)</h2>

        <div class="stat-grid">
            <div>
                <label>í˜„ì¬ STR (ë‚´ê°€ ì°ì€ ìŠ¤íƒ¯)</label>
                <input type="number" id="statStr" placeholder="ì˜ˆ: 80">
            </div>

            <div>
                <label>í˜„ì¬ DEX (ë‚´ê°€ ì°ì€ ìŠ¤íƒ¯)</label>
                <input type="number" id="statDex" placeholder="ì˜ˆ: 234">
            </div>

            <div>
                <label>í˜„ì¬ ê³µê²©ë ¥ (ì¥ë¹„ í¬í•¨)</label>
                <input type="number" id="statAtk" placeholder="ì˜ˆ: 309">
            </div>

            <div>
                <label>í˜„ì¬ ì¹˜ëª…íƒ€ í™•ë¥  (%)</label>
                <input type="number" id="statCrit" step="0.01" placeholder="ì˜ˆ: 222.87">
            </div>

            <div>
                <label>í˜„ì¬ íšŒí”¼ ìˆ˜ì¹˜ (ìš´ì˜ì ê³µì§€ì˜ Xê°’)</label>
                <input type="number" id="statEvade" step="0.01" placeholder="ì˜ˆ: 111.75">
            </div>
        </div>

        <button onclick="runStatCalc()">ìŠ¤íƒ¯ ìµœì í™” ê³„ì‚°í•˜ê¸°</button>

        <div class="r" id="statResult">
            í˜„ì¬ STR/DEX, ê³µê²©ë ¥, ì¹˜ëª…íƒ€, íšŒí”¼ ìˆ˜ì¹˜ë¥¼ ì…ë ¥í•˜ë©´<br>
            â–· DEX 1í¬ì¸íŠ¸ì˜ <b>í‘œê¸° íšŒí”¼ vs ì‹¤ì œ íšŒí”¼%</b> ë³€í™”<br>
            â–· STR 1 vs DEX 1 <b>ë”œ íš¨ìœ¨ ë¹„êµ</b><br>
            â–· <b>ë”œÃ—ìƒì¡´(íšŒí”¼)</b>ì„ í•¨ê»˜ ë´¤ì„ ë•Œ ìµœì  STR/DEX ë°°ë¶„<br>
            ì„ ê³„ì‚°í•´ì¤ë‹ˆë‹¤.
        </div>
    </div>

</div>
<script>

function runCustomStatTest(){
    const base = window._statBaseData;
    if(!base){
        alert("ë¨¼ì € ìœ„ì˜ ìŠ¤íƒ¯ ìµœì í™” ê³„ì‚°ì„ í•œ ë²ˆ ì‹¤í–‰í•´ì£¼ì„¸ìš”.");
        return;
    }
    const out = document.getElementById("statHypoResult");
    const strInput = document.getElementById("statHypoStr");
    const dexInput = document.getElementById("statHypoDex");

    if(!out || !strInput || !dexInput){
        return;
    }

    const STR_new = parseFloat(strInput.value);
    const DEX_new = parseFloat(dexInput.value);

    if(isNaN(STR_new) || isNaN(DEX_new)){
        out.innerHTML = "STRê³¼ DEXë¥¼ ìˆ«ìë¡œ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        return;
    }
    if(STR_new < 0 || DEX_new < 0){
        out.innerHTML = "STRê³¼ DEXëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
        return;
    }

    const atk_new   = base.baseAtk   + STR_new * 0.35;
    const crit_new  = base.baseCrit  + DEX_new * 0.18;
    const evStatNew = base.baseEvade + DEX_new * 0.18;

    const mult      = avgMultiplierFromCrit(crit_new);
    const dps       = atk_new * mult;

    const evadeAppliedRaw = (evStatNew <= 0) ? 0 : (evStatNew / (evStatNew + 100)) * 100;
    const evadeForSurvival = Math.min(evadeAppliedRaw, 50);

    let hitChance = 1 - (evadeForSurvival / 100);
    if(hitChance < 0.01) hitChance = 0.01;

    const survivalScore = 1 / hitChance;
    const effScore      = dps * survivalScore;

    const diffEffPercent = ((effScore / base.currentEff) - 1) * 100;
    const diffEffRounded = Math.round(diffEffPercent * 10) / 10;

    const evadeStr = evadeAppliedRaw.toFixed(2);
    const atkStr   = atk_new.toFixed(2);
    const dpsStr   = dps.toFixed(2);

    let msg = "";
    msg += `ì–´ë””ê¹Œì§€ë‚˜ ì •ë‹µì€ ì—†ê³ , ì²´ê°ìƒ ì‹¤ íšŒí”¼ìœ¨ 50%ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•©ë‹ˆë‹¤.<br>`;
    msg += `ì˜ˆìƒ ë°°ë¶„ : DEX <b>${DEX_new}</b>, STR <b>${STR_new}</b><br>`;
    msg += `ì˜ˆìƒ í‰ê·  ë”œ: ì•½ <b>${dpsStr}</b><br>`;
    msg += `ì¶”ì²œ ë¶„ë°° ì‹œ ìµœì¢… ê³µê²©ë ¥: ì•½ <b>${atkStr}</b><br>`;
    msg += `ì¶”ì²œ ë¶„ë°° ì‹œ ìµœì¢… íšŒí”¼ ìˆ˜ì¹˜(X): <b>${evStatNew.toFixed(2)}</b><br>`;
    msg += `ì¶”ì²œ ë¶„ë°° ì‹œ ì‹¤ì œ íšŒí”¼: ì•½ <b>${evadeStr}%</b><br>`;
    msg += `í˜„ì¬ ëŒ€ë¹„ ì´ íš¨ìœ¨(DPSÃ—ìƒì¡´) ë³€í™”: <b>${diffEffRounded}%</b>` +
           (diffEffRounded > 0 ? " ì¦ê°€" : (diffEffRounded < 0 ? " ê°ì†Œ" : " ë³€í™” ì—†ìŒ")) + "<br>";

    out.innerHTML = msg;
}


// ìƒì + ê°•í™” ì¢…í•© ì‹œë®¬ë ˆì´í„°
const BOX_COST_GOLD_C = 200000;
const BOX_COST_DIA_A  = 3900;

function getScrollCostByPart(part){
    if(part === "accessory") return 200000; // ì¥ì‹ êµ¬
    return 100000; // ë¬´ê¸°, ë°©ì–´êµ¬
}

// boxRatesByPart, upgradeSuccessRate, maxByType, safeToByType ì´ë¯¸ ì •ì˜ë˜ì–´ ìˆìŒ

function simulateBoxesForTier(part, boxGrade, targetTier){
    const table = boxRatesByPart[part][boxGrade];
    if(!table){
        return {boxes:0, hit:false};
    }
    const entries = Object.entries(table);
    const totalP  = entries.reduce((s,[,v])=>s+v,0);

    let boxes = 0;
    while(true){
        boxes++;
        let r = Math.random() * totalP;
        let sum = 0;
        let got = null;
        for(const [grade, p] of entries){
            sum += p;
            if(r <= sum){
                got = grade;
                break;
            }
        }
        if(got === targetTier){
            return {boxes, hit:true};
        }
        if(boxes > 1000000){
            return {boxes, hit:false};
        }
    }
}

function simulateUpgradeToTarget(part, targetLevel){
    const maxLv  = maxByType[part];
    const safeLv = safeToByType[part];
    let lv = 0;
    let scrolls = 0;
    let breaks  = 0;

    if(targetLevel > maxLv) targetLevel = maxLv;

    while(lv < targetLevel){
        scrolls++;
        const rate = upgradeSuccessRate(part, lv);
        const r = Math.random();
        if(r < rate){
            lv++;
            if(lv > maxLv) lv = maxLv;
        }else{
            if(lv < safeLv){
                // ì•ˆì „ êµ¬ê°„: ìœ ì§€
            }else{
                const r2 = Math.random();
                if(r2 < 1/3){
                    // ìœ ì§€
                }else if(r2 < 2/3){
                    lv = Math.max(0, lv-1);
                }else{
                    lv = 0;
                    breaks++;
                }
            }
        }
        if(scrolls > 1000000){
            break;
        }
    }
    return {scrolls, breaks};
}


function updateTotalCostTargetOptions(){
    const partSel = document.getElementById("tc_part");
    const targetSel = document.getElementById("tc_targetLv");
    if(!partSel || !targetSel) return;

    let maxLv;
    if(partSel.value === "weapon"){
        maxLv = maxByType.weapon;
    }else if(partSel.value === "armor"){
        maxLv = maxByType.armor;
    }else{
        maxLv = maxByType.accessory;
    }

    const currentVal = parseInt(targetSel.value, 10) || maxLv;
    targetSel.innerHTML = "";
    for(let lv = 1; lv <= maxLv; lv++){
        const opt = document.createElement("option");
        opt.value = String(lv);
        opt.textContent = "+" + lv;
        if(lv === Math.min(currentVal, maxLv)){
            opt.selected = true;
        }
        targetSel.appendChild(opt);
    }
}
function runTotalCostSim(){
    const partSel = document.getElementById("tc_part");
    const tierSel = document.getElementById("tc_tier");
    const boxSel  = document.getElementById("tc_boxGrade");
    const targetSel = document.getElementById("tc_targetLv");
    const runsInput = document.getElementById("tc_runs");
    const out = document.getElementById("tc_result");

    if(!partSel || !tierSel || !boxSel || !targetSel || !runsInput || !out){
        return;
    }

    let part = partSel.value;
    let tier = tierSel.value;
    const boxGrade = boxSel.value;
    let targetLevel = parseInt(targetSel.value, 10);
    let runs = parseInt(runsInput.value, 10);

    if(part !== "weapon"){
        tier = "X";
        tierSel.value = "X";
    }

    if(isNaN(targetLevel) || targetLevel < 1) targetLevel = 10;
    if(isNaN(runs) || runs < 10) runs = 10;
    if(runs > 5000) runs = 5000;

    let totalBoxes = 0;
    let totalScrolls = 0;
    let totalBreaks  = 0;

    for(let i=0;i<runs;i++){
        const boxSim = simulateBoxesForTier(part, boxGrade, tier);
        totalBoxes += boxSim.boxes;

        const upgSim = simulateUpgradeToTarget(part, targetLevel);
        totalScrolls += upgSim.scrolls;
        totalBreaks  += upgSim.breaks;
    }

    const avgBoxes   = totalBoxes / runs;
    const avgScrolls = totalScrolls / runs;
    const avgBreaks  = totalBreaks / runs;

    const scrollCost = getScrollCostByPart(part);

    // ì •ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ë³´ì—¬ì£¼ê¸° ìœ„í•´ ë°˜ì˜¬ë¦¼ ì²˜ë¦¬
    const boxesInt   = Math.round(avgBoxes);
    const scrollsInt = Math.round(avgScrolls);
    const breaksInt  = Math.round(avgBreaks);

    const avgScrollGold = scrollsInt * scrollCost;

    let boxCostText = "";
    if(boxGrade === "C"){
        const avgBoxGold = boxesInt * BOX_COST_GOLD_C;
        boxCostText = `í‰ê·  ìƒì ë¹„ìš©: ì•½ <b>${boxesInt.toLocaleString()}ê°œ</b> (â‰ˆ <b>${avgBoxGold.toLocaleString()} ê³¨ë“œ</b>)`;
    }else{
        const avgBoxDia = boxesInt * BOX_COST_DIA_A;
        boxCostText = `í‰ê·  ìƒì ë¹„ìš©: ì•½ <b>${boxesInt.toLocaleString()}ê°œ</b> (â‰ˆ <b>${avgBoxDia.toLocaleString()} ë‹¤ì´ì•„</b>)`;
    }

    let msg = "";
    msg += `ì¥ë¹„ ì¢…ë¥˜: <b>${part === "weapon" ? "ë¬´ê¸°" : (part === "armor" ? "ë°©ì–´êµ¬" : "ì¥ì‹ êµ¬")}</b><br>`;
    msg += `ë…¸ë¦¬ëŠ” ë“±ê¸‰: <b>${tier}</b>, ìƒì: <b>${boxGrade} ë“±ê¸‰</b>, ëª©í‘œ ê°•í™”: <b>+${targetLevel}</b><br><br>`;
    msg += `${boxCostText}<br>`;
    msg += `í‰ê·  ì‚¬ìš© ê°•í™” ì£¼ë¬¸ì„œ: ì•½ <b>${scrollsInt.toLocaleString()}ì¥</b> (â‰ˆ <b>${avgScrollGold.toLocaleString()} ê³¨ë“œ</b>)<br>`;
    msg += `í‰ê·  ì¥ë¹„ íŒŒê´´ íšŸìˆ˜: ì•½ <b>${breaksInt.toLocaleString()}íšŒ</b><br>`;
    msg += `<small>â€» í™•ë¥  ê¸°ë°˜ ëŒ€ëµì ì¸ í‰ê· ê°’ì…ë‹ˆë‹¤. ê°œë³„ ì‹œë„ì—ì„œëŠ” ìš´ì— ë”°ë¼ í¬ê²Œ ì°¨ì´ë‚  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</small>`;

    out.innerHTML = msg;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ê³µí†µ: ë‹¤í¬ ëª¨ë“œ
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const DARK_KEY = "bladeup_dark_mode";

const RETRO_KEY = "bladeup_retro_theme";

function applyRetroFromStorage(){
    const v = localStorage.getItem(RETRO_KEY);
    if(v === "1"){
        document.body.classList.add("retro-theme");
    }else{
        document.body.classList.remove("retro-theme");
    }
}

function toggleRetroTheme(){
    const isRetro = document.body.classList.toggle("retro-theme");
    localStorage.setItem(RETRO_KEY, isRetro ? "1" : "0");
}


function applyDarkModeFromStorage(){
    const v = localStorage.getItem(DARK_KEY);
    if(v === "1"){
        document.body.classList.add("dark-mode");
    }else{
        document.body.classList.remove("dark-mode");
    }
}

function toggleDarkMode(){
    const isDark = document.body.classList.toggle("dark-mode");
    localStorage.setItem(DARK_KEY, isDark ? "1" : "0");
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ê²½í—˜ì¹˜ ê³„ì‚°ê¸°
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function expCalc(){
    const m = Number(document.getElementById("exp_mon").value);      // í‘œê¸° ëª¬ìŠ¤í„° EXP
    const n = Number(document.getElementById("exp_shield").value);   // ë°©íŒ¨ ê°•í™” ë‹¨ê³„
    const out = document.getElementById("exp_result");

    if(n === 0){
        out.innerHTML = "ë°©íŒ¨ ê°•í™” ë‹¨ê³„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.";
        return;
    }

    const baseExp = m / 1.5;          // PK 50% í¬í•¨ëœ í‘œê¸° â†’ ì›ê²½í—˜ì¹˜
    let equipBonus = (n - 4) * 0.1;   // 5ê°•ë¶€í„° 10%ì”©
    if(equipBonus < 0) equipBonus = 0;

    const totalMult = 1 + 0.5 + equipBonus; // 1(ê¸°ë³¸) + 0.5(PK) + ì¥ë¹„
    const finalExp = Math.floor(baseExp * totalMult);

    function fmtPercent(v){
        const p = v*100;
        if(p < 0.0001) return "0%";
        return Number.isInteger(p) ? p + "%" : p.toFixed(1) + "%";
    }

    out.innerHTML =
        "<b>ğŸ“Œ ìµœì¢… ê³„ì‚° ê²°ê³¼</b><br>" +
        "ì„ íƒ ëª¬ìŠ¤í„° ê²½í—˜ì¹˜(í‘œê¸°): <b>" + m + "</b><br>" +
        "ì›ê²½í—˜ì¹˜(Base EXP): <b>" + baseExp.toFixed(0) + "</b><br>" +
        "ì¥ë¹„ ê²½í—˜ì¹˜ ë³´ë„ˆìŠ¤: <b>" + fmtPercent(equipBonus) + "</b><br>" +
        "PKì¡´ ë³´ë„ˆìŠ¤: <b>50%</b><br><br>" +
        "â–¶ <b>íšë“ ê²½í—˜ì¹˜: " + finalExp + "</b><br><br>" +
        "<b>ğŸ“˜ ê²½í—˜ì¹˜ ê³µì‹</b><br>" +
        "í‘œê¸° ê²½í—˜ì¹˜ = ì›ê²½í—˜ì¹˜ Ã— 1.5 (PK 50% í¬í•¨)<br>" +
        "ìµœì¢… ê²½í—˜ì¹˜ = ì›ê²½í—˜ì¹˜ Ã— (1 + PK + ì¥ë¹„ë³´ë„ˆìŠ¤)";
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ìƒì ì‹œë®¬ë ˆì´í„°
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// ë¬´ê¸° í™•ë¥ 
const weaponRates = {
    "D": {
        "X+":0.000100,"X":0.000200,"SSS+":0.000500,"SSS":0.000800,"SS+":0.001000,"SS":0.002000,
        "S+":0.010000,"S":0.015000,"A+":0.030000,"A":0.050000,"B":0.070000,"C":0.090000,
        "D":0.111200,"E":0.223200,"F":0.396000
    },
    "C": {
        "X+":0.000200,"X":0.000500,"SSS+":0.001000,"SSS":0.002000,"SS+":0.003000,"SS":0.004000,
        "S+":0.020000,"S":0.025000,"A+":0.050000,"A":0.070000,"B":0.090000,"C":0.100000,
        "D":0.148800,"E":0.173200,"F":0.312300
    },
    "B": {
        "X+":0.005000,"X":0.010000,"SSS+":0.013000,"SSS":0.016000,"SS+":0.020000,"SS":0.021000,
        "S+":0.048500,"S":0.062300,"A+":0.112100,"A":0.123100,"B":0.082200,"C":0.092000,
        "D":0.101400,"E":0.112300,"F":0.181100
    },
    "A": {
        "X+":0.015000,"X":0.023000,"SSS+":0.030000,"SSS":0.032000,"SS+":0.042000,"SS":0.052100,
        "S+":0.108500,"S":0.142300,"A+":0.101100,"A":0.113200,"B":0.097200,"C":0.056300,
        "D":0.053200,"E":0.072100,"F":0.062000
    }
};

// ë°©ì–´êµ¬
const armorRates = {
    "D": {
        "X":0.0001,"SSS":0.0005,"SS":0.0010,"S":0.0030,"A":0.0130,
        "B":0.0320,"C":0.0818,"D":0.1721,"E":0.3212,"F":0.3753
    },
    "C": {
        "X":0.0005,"SSS":0.0030,"SS":0.0030,"S":0.0080,"A":0.0292,
        "B":0.0920,"C":0.1232,"D":0.2167,"E":0.2123,"F":0.3121
    },
    "B": {
        "X":0.0050,"SSS":0.0100,"SS":0.0130,"S":0.0350,"A":0.0750,
        "B":0.1540,"C":0.1572,"D":0.1523,"E":0.1752,"F":0.2233
    },
    "A": {
        "X":0.0150,"SSS":0.0230,"SS":0.0450,"S":0.0923,"A":0.1962,
        "B":0.1802,"C":0.1213,"D":0.1079,"E":0.1120,"F":0.1071
    }
};

// ì¥ì‹ êµ¬
const accessoryRates = {
    "D": {
        "X":0.0001,"S":0.0010,"A":0.0030,"B":0.0240,"C":0.1003,
        "D":0.1602,"E":0.3002,"F":0.4112
    },
    "C": {
        "X":0.0005,"S":0.0015,"A":0.0100,"B":0.0432,"C":0.1552,
        "D":0.2443,"E":0.2232,"F":0.3221
    },
    "B": {
        "X":0.0050,"S":0.0100,"A":0.0250,"B":0.1211,"C":0.1732,
        "D":0.1922,"E":0.2121,"F":0.2614
    },
    "A": {
        "X":0.0150,"S":0.0230,"A":0.0480,"B":0.2221,"C":0.1896,
        "D":0.1632,"E":0.1821,"F":0.1570
    }
};

const boxRatesByPart = {
    weapon: weaponRates,
    armor: armorRates,
    accessory: accessoryRates
};
const boxOrder = {
    weapon: ["X+","X","SSS+","SSS","SS+","SS","S+","S","A+","A","B","C","D","E","F"],
    armor:  ["X","SSS","SS","S","A","B","C","D","E","F"],
    accessory: ["X","S","A","B","C","D","E","F"]
};
const boxLabel = {
    weapon:"ë¬´ê¸°",
    armor:"ë°©ì–´êµ¬",
    accessory:"ì¥ì‹ êµ¬"
};

let boxAccumCount = {};
let boxBoxCount   = {D:0, C:0, B:0, A:0};

function boxHighlight(name){
    if(name==="X+" || name==="X"){
        return `<span class="yellow-highlight"><b>${name}</b></span>`;
    }
    return `<b>${name}</b>`;
}
function boxPercent(p){
    return (p*100).toFixed(3).replace(/0+$/,'').replace(/\.$/,'') + "%";
}

function getBoxPart(){ return document.getElementById("box_part").value; }
function getBoxGrade(){ return document.getElementById("box_grade").value; }

function resetBoxAccum(){
    boxAccumCount = {};
    boxBoxCount   = {D:0, C:0, B:0, A:0};
    document.getElementById("box_accum").innerHTML = "ì•„ì§ ì—†ìŒ";
}

function updateBoxProb(){
    const part  = getBoxPart();
    const grade = getBoxGrade();
    const table = boxRatesByPart[part][grade];
    const order = boxOrder[part];

    let html = `<b>[${boxLabel[part]} ${grade} ë“±ê¸‰ ë°•ìŠ¤ í™•ë¥ ]</b><br><br>`;

    // X+, X ë¨¼ì €
    const specials = [];
    if(order.includes("X+")) specials.push("X+");
    if(order.includes("X"))  specials.push("X");

    specials.forEach(g=>{
        if(table[g] !== undefined){
            html += `${boxHighlight(g)} : ${boxPercent(table[g])}<br>`;
        }
    });
    if(specials.some(g=>table[g]!==undefined)) html += "<br>";

    order.filter(g=>!specials.includes(g)).forEach(g=>{
        if(table[g] !== undefined){
            html += `${boxHighlight(g)} : ${boxPercent(table[g])}<br>`;
        }
    });

    document.getElementById("box_prob").innerHTML = html;
}

function openBox(times){
    const part  = getBoxPart();
    const grade = getBoxGrade();
    const table = boxRatesByPart[part][grade];
    const entries = Object.entries(table);
    const totalP  = entries.reduce((s,[,v])=>s+v,0);

    const resultArr = [];
    for(let i=0;i<times;i++){
        let r = Math.random()*totalP;
        let sum = 0;
        for(const [name,p] of entries){
            sum += p;
            if(r <= sum){
                resultArr.push(name);
                break;
            }
        }
    }

    // ì´ë²ˆ ê²°ê³¼
    const order = boxOrder[part];
    const count = {};
    resultArr.forEach(x=>{
        if(!count[x]) count[x]=0;
        count[x]++;
    });

    let html = "<b>ì´ë²ˆ ê²°ê³¼</b><br><br>";
    const specials = [];
    if(order.includes("X+")) specials.push("X+");
    if(order.includes("X"))  specials.push("X");
    specials.forEach(g=>{
        if(count[g]) html += `${boxHighlight(g)} : ${count[g]}ê°œ<br>`;
    });
    if(specials.some(g=>count[g])) html += "<br>";

    let line = "";
    order.filter(g=>!specials.includes(g)).forEach(g=>{
        if(count[g]) line += `${boxHighlight(g)}:${count[g]}ê°œ `;
    });
    if(line==="") line = "ì•„ì§ ì—†ìŒ";
    html += line;
    document.getElementById("box_result").innerHTML = html;

    // ëˆ„ì  ë°˜ì˜
    resultArr.forEach(x=>{
        if(!boxAccumCount[x]) boxAccumCount[x]=0;
        boxAccumCount[x]++;
    });
    boxBoxCount[grade] += times;

    let ahtml = "<b>ëˆ„ì  ê²°ê³¼</b><br><br>";
    ahtml += "<b>ëˆ„ì  ê¹ ìƒì ìˆ˜</b><br>";
    ahtml += `D : ${boxBoxCount.D}ê°œ&nbsp;&nbsp;C : ${boxBoxCount.C}ê°œ&nbsp;&nbsp;B : ${boxBoxCount.B}ê°œ&nbsp;&nbsp;A : ${boxBoxCount.A}ê°œ<br><br>`;

    specials.forEach(g=>{
        if(boxAccumCount[g]) ahtml += `${boxHighlight(g)} : ${boxAccumCount[g]}ê°œ<br>`;
    });
    if(specials.some(g=>boxAccumCount[g])) ahtml += "<br>";

    let line2="";
    order.filter(g=>!specials.includes(g)).forEach(g=>{
        if(boxAccumCount[g]) line2 += `${boxHighlight(g)}:${boxAccumCount[g]}ê°œ `;
    });
    if(line2==="") line2="ì•„ì§ ì—†ìŒ";
    ahtml += line2;
    document.getElementById("box_accum").innerHTML = ahtml;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ì¥ë¹„ ê°•í™” ì‹œë®¬ë ˆì´í„°
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

// ì•ˆì „êµ¬ê°„ / ìµœëŒ€ê°•
const safeToByType = { weapon:6, armor:4, accessory:3 };
const maxByType    = { weapon:15, armor:10, accessory:8 };

// ì„±ê³µ í™•ë¥  (ì‹œì‘ ë‹¨ê³„ â†’ ë‹¤ìŒ ë‹¨ê³„)
const successRates = {
    weapon:{
        6:0.60, 7:0.50, 8:0.40, 9:0.30,
        10:0.25, 11:0.20, 12:0.15, 13:0.10, 14:0.05
    },
    armor:{
        4:0.40, 5:0.30, 6:0.20, 7:0.15, 8:0.10, 9:0.05
    },
    accessory:{
        3:0.33, 4:0.20, 5:0.13, 6:0.07, 7:0.03
    }
};

let upgTimer = null;
let upgLoopGuard = 0;
const UPG_LOOP_MAX = 200000;

let upgStats = {
    scrolls:0,
    items:0,
    perLevel:{}
};

function ensureLevelStat(lv){
    if(!upgStats.perLevel[lv]){
        upgStats.perLevel[lv] = {success:0, keep:0, down:0, broke:0};
    }
}

function upgradeSuccessRate(type, lv){
    const maxLv  = maxByType[type];
    const safeLv = safeToByType[type];
    if(lv >= maxLv) return 0;
    if(lv < safeLv) return 1.0;
    const table = successRates[type] || {};
    if(table[lv] !== undefined) return table[lv];
    return 0.01;
}

function upgradeOnce(type, currentLevel){
    const maxLv  = maxByType[type];
    const safeLv = safeToByType[type];
    let lv = currentLevel;
    if(lv >= maxLv) return {level:lv, text:`ì´ë¯¸ ìµœëŒ€ ê°•í™”(+${maxLv})ì…ë‹ˆë‹¤.`, cls:"info", noScroll:false};

    upgStats.scrolls++;

    const rate = upgradeSuccessRate(type, lv);
    const r = Math.random();
    if(r < rate){
        // ì„±ê³µ
        lv++;
        if(lv > maxLv) lv = maxLv;
        if(lv-1 >= safeLv){
            ensureLevelStat(lv-1);
            upgStats.perLevel[lv-1].success++;
        }
        return {level:lv, text:`+${currentLevel} â†’ <b>ì„±ê³µ</b> â†’ +${lv}`, cls:"success", noScroll:false};
    }else{
        // ì‹¤íŒ¨
        if(lv < safeLv){
            return {level:lv, text:`+${lv} â†’ ì‹¤íŒ¨ (ì•ˆì „êµ¬ê°„, ë‹¨ê³„ ìœ ì§€)`, cls:"keep", noScroll:false};
        }else{
            ensureLevelStat(lv);
            const r2 = Math.random();
            if(r2 < 1/3){
                upgStats.perLevel[lv].keep++;
                return {level:lv, text:`+${lv} â†’ ì‹¤íŒ¨ (ë‹¨ê³„ ìœ ì§€)`, cls:"keep", noScroll:false};
            }else if(r2 < 2/3){
                lv = Math.max(0, lv-1);
                upgStats.perLevel[lv+1].down++;
                return {level:lv, text:`+${lv+1} â†’ ì‹¤íŒ¨ (<b>í•˜ë½</b>) â†’ +${lv}`, cls:"down", noScroll:false};
            }else{
                upgStats.items++;
                lv = 0;
                upgStats.perLevel[currentLevel].broke++;
                return {level:lv, text:`+${currentLevel} â†’ ì‹¤íŒ¨ (<b>íŒŒê´´</b>) â†’ ì¥ë¹„ íŒŒê´´, +0ë¶€í„° ë‹¤ì‹œ`, cls:"break", noScroll:false};
            }
        }
    }
}

function appendUpgradeLog(msg, cls){
    const el = document.getElementById("upg_log");
    const div = document.createElement("div");
    div.style.fontSize="13px";
    div.style.marginBottom="3px";
    if(cls==="success") div.style.color="#16a34a";
    else if(cls==="keep") div.style.color="#6b7280";
    else if(cls==="down") div.style.color="#d97706";
    else if(cls==="break") div.style.color="#ef4444";
    else div.style.color="#e5e7eb";

    div.innerHTML = msg;
    if(el.firstChild) el.insertBefore(div, el.firstChild);
    else el.appendChild(div);

    // ì˜¤ë˜ëœ ë¡œê·¸ ì‚­ì œ
    while(el.children.length > 80){
        el.removeChild(el.lastChild);
    }
}

function updateUpgradeStatsDisplay(){
    const safeLv = safeToByType[document.getElementById("upg_type").value];
    const statsDiv = document.getElementById("upg_stats");
    let html = "";
    html += `ëˆ„ì  ì£¼ë¬¸ì„œ ì‚¬ìš©: <b>${upgStats.scrolls}</b> ê°œ<br>`;
    html += `ëˆ„ì  ì¥ë¹„ íŒŒê´´: <b>${upgStats.items}</b> ê°œ<br><br>`;

    const levels = Object.keys(upgStats.perLevel)
          .map(x=>parseInt(x,10))
          .filter(l => l >= safeLv)
          .sort((a,b)=>a-b);

    if(levels.length === 0){
        html += "ì•„ì§ í†µê³„ê°€ ì—†ìŠµë‹ˆë‹¤.";
    }else{
        levels.forEach(l=>{
            const st = upgStats.perLevel[l];
            html += `<b>${l}ê°•</b> - ì„±ê³µ:${st.success} / ìœ ì§€:${st.keep} / í•˜ë½:${st.down} / íŒŒê´´:${st.broke}<br>`;
        });
    }
    statsDiv.innerHTML = html;
}

function updateUpgradeProb(){
    const type = document.getElementById("upg_type").value;
    const safeLv = safeToByType[type];
    const maxLv  = maxByType[type];
    const box = document.getElementById("upg_prob");

    let label = (type==="weapon"?"ë¬´ê¸°":type==="armor"?"ë°©ì–´êµ¬":"ì¥ì‹ êµ¬");
    let html = `<b>[${label} ê°•í™” í™•ë¥ ]</b><br><br>`;

    for(let lv=0; lv<maxLv; lv++){
        const next = lv+1;
        let rate;
        if(lv < safeLv){
            rate = 1.0;
        }else{
            const t = successRates[type] || {};
            rate = t[lv];
            if(rate === undefined) rate = 0.01;
        }
        const pct = Math.round(rate*10000)/100;
        html += `${lv}ê°• â†’ ${next}ê°• : <b>${pct}%</b>`;
        if(lv < safeLv) html += " (ì•ˆì „ê°•í™”)";
        html += "<br>";
    }
    box.innerHTML = html;
}

function initUpgradeSelects(){
    const typeSel = document.getElementById("upg_type");
    const nowSel  = document.getElementById("upg_now");
    const tgtSel  = document.getElementById("upg_target");
    const type = typeSel.value;
    const maxLv = maxByType[type];

    nowSel.innerHTML = "";
    tgtSel.innerHTML = "";

    for(let lv=0; lv<=maxLv; lv++){
        const op = document.createElement("option");
        op.value = lv;
        op.textContent = lv + "ê°•";
        nowSel.appendChild(op);
    }
    for(let lv=1; lv<=maxLv; lv++){
        const op = document.createElement("option");
        op.value = lv;
        op.textContent = lv + "ê°•";
        if(lv === maxLv) op.selected = true;
        tgtSel.appendChild(op);
    }
}

function resetUpgrade(){
    upgStats = {scrolls:0, items:0, perLevel:{}};
    document.getElementById("upg_log").innerHTML = "";
    updateUpgradeStatsDisplay();
}

function startUpgrade(){
    if(upgTimer){
        clearInterval(upgTimer);
        upgTimer = null;
    }
    const type   = document.getElementById("upg_type").value;
    const nowSel = document.getElementById("upg_now");
    const tgtSel = document.getElementById("upg_target");
    const speed  = Number(document.getElementById("upg_speed").value) || 1;

    let currentLevel = Number(nowSel.value);
    const targetLevel = Number(tgtSel.value);
    const maxLv = maxByType[type];

    if(targetLevel <= currentLevel){
        appendUpgradeLog(`ì´ë¯¸ ëª©í‘œ ê°•í™” ë‹¨ê³„(+${targetLevel}) ì´ìƒì…ë‹ˆë‹¤.`, "info");
        return;
    }

    const baseDelay = 70; // ê¸°ë³¸ ë”œë ˆì´
    const delay = Math.max(4, baseDelay / speed);

    upgLoopGuard = 0;

    upgTimer = setInterval(()=>{
        upgLoopGuard++;
        if(upgLoopGuard > UPG_LOOP_MAX){
            clearInterval(upgTimer);
            upgTimer = null;
            appendUpgradeLog("ê°•í™”ê°€ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë ¤ ìë™ìœ¼ë¡œ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. (ë³´í˜¸ì¥ì¹˜)", "info");
            return;
        }

        if(currentLevel >= targetLevel || currentLevel >= maxLv){
            clearInterval(upgTimer);
            upgTimer = null;
            appendUpgradeLog(`ê°•í™” ì¢…ë£Œ: ìµœì¢… +${currentLevel} ë„ë‹¬ (ëª©í‘œ +${targetLevel})`, "info");
            // í˜„ì¬ ë‹¨ê³„ select ì—…ë°ì´íŠ¸
            document.getElementById("upg_now").value = currentLevel;
            return;
        }

        const res = upgradeOnce(type, currentLevel);
        currentLevel = res.level;
        appendUpgradeLog(res.text, res.cls);
        updateUpgradeStatsDisplay();
        document.getElementById("upg_now").value = currentLevel;

    }, delay);
}

function stopUpgrade(){
    if(upgTimer){
        clearInterval(upgTimer);
        upgTimer = null;
        appendUpgradeLog("ê°•í™”ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì¤‘ì§€í–ˆìŠµë‹ˆë‹¤.", "info");
    }
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ìŠ¤íƒ¯ íš¨ìœ¨ ê³„ì‚°ê¸° (ë”œ+íšŒí”¼ ê· í˜•)
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */

const STAT_LS_KEY = "bladeup_stat_calc_A_only";

function avgMultiplierFromCrit(crit){
    if(crit <= 100){
        return 1 + 0.005 * crit;
    }else{
        return 0.5 + 0.01 * crit;
    }
}

function saveStatInputs(str, dex, atk, crit, evade){
    try{
        const obj = {str, dex, atk, crit, evade};
        localStorage.setItem(STAT_LS_KEY, JSON.stringify(obj));
    }catch(e){}
}

function loadStatInputs(){
    try{
        const raw = localStorage.getItem(STAT_LS_KEY);
        if(!raw) return;
        const obj = JSON.parse(raw);
        if(typeof obj.str   === "number") document.getElementById("statStr").value   = obj.str;
        if(typeof obj.dex   === "number") document.getElementById("statDex").value   = obj.dex;
        if(typeof obj.atk   === "number") document.getElementById("statAtk").value   = obj.atk;
        if(typeof obj.crit  === "number") document.getElementById("statCrit").value  = obj.crit;
        if(typeof obj.evade === "number") document.getElementById("statEvade").value = obj.evade;
    }catch(e){}
}

function runStatCalc(){
    const strVal   = parseFloat(document.getElementById("statStr").value);
    const dexVal   = parseFloat(document.getElementById("statDex").value);
    const atkVal   = parseFloat(document.getElementById("statAtk").value);
    const critVal  = parseFloat(document.getElementById("statCrit").value);
    const evadeVal = parseFloat(document.getElementById("statEvade").value);
    const out = document.getElementById("statResult");

    if(isNaN(strVal) || isNaN(dexVal) || isNaN(atkVal) || isNaN(critVal) || isNaN(evadeVal)){
        out.innerHTML = "ëª¨ë“  ê°’ì„ ìˆ«ìë¡œ ì •í™•íˆ ì…ë ¥í•´ì£¼ì„¸ìš”. (STR, DEX, ê³µê²©ë ¥, ì¹˜ëª…, íšŒí”¼ ìˆ˜ì¹˜)";
        return;
    }
    if(strVal < 0 || dexVal < 0){
        out.innerHTML = "STRê³¼ DEXëŠ” 0 ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
        return;
    }

    const totalStat = strVal + dexVal;
    if(totalStat <= 0){
        out.innerHTML = "ì´ ìŠ¤íƒ¯(STR+DEX)ì´ 0 ì´í•˜ì…ë‹ˆë‹¤. ê°’ì„ ë‹¤ì‹œ í™•ì¸í•´ì£¼ì„¸ìš”.";
        return;
    }

    // í˜„ì¬ ìŠ¤íƒ¯ì—ì„œ ìŠ¤íƒ¯ ê¸°ì—¬ë¶„ì„ ë¹¼ê³  "ê¸°ë³¸" ì¶”ì •
    const baseAtk   = atkVal   - strVal * 0.35;
    const baseCrit  = critVal  - dexVal * 0.18;
    const baseEvade = evadeVal - dexVal * 0.18; // ì¥ë¹„/ê¸°ë³¸ íšŒí”¼ ìˆ˜ì¹˜

    function appliedEvade(evStat){
        if(evStat <= 0) return 0;
        return (evStat / (evStat + 100)) * 100;
    }

    // íŠ¹ì • STR/DEX ë°°ë¶„ì—ì„œ ë”œ/íšŒí”¼/ìƒì¡´/íš¨ìœ¨ ê³„ì‚°
    function calcAll(STR_new, DEX_new){
        const atk_new   = baseAtk   + STR_new * 0.35;
        const crit_new  = baseCrit  + DEX_new * 0.18;
        const evStatNew = baseEvade + DEX_new * 0.18;

        const mult      = avgMultiplierFromCrit(crit_new);
        const dps       = atk_new * mult;

        const evadeAppliedRaw = appliedEvade(evStatNew);
        // íš¨ìœ¨ ê³„ì‚°ì—ì„œëŠ” ì‹¤ì œ íšŒí”¼ìœ¨ì„ ìµœëŒ€ 50%ê¹Œì§€ë§Œ ë°˜ì˜
        const evadeForSurvival = Math.min(evadeAppliedRaw, 50);

        let hitChance = 1 - (evadeForSurvival / 100); // ëª¬ìŠ¤í„° ëª…ì¤‘ 100% ê°€ì •
        if(hitChance < 0.01) hitChance = 0.01;        // ë„ˆë¬´ ë‚®ìœ¼ë©´ ë°”ë‹¥ê°’ 1%

        const survivalScore = 1 / hitChance;
        const effScore      = dps * survivalScore;

        return {
            dps,
            atk: atk_new,
            crit: crit_new,
            evStat: evStatNew,
            evadeApplied: evadeAppliedRaw,
            survivalScore,
            effScore
        };
    }

    // í˜„ì¬ ìƒíƒœ
    const current = calcAll(strVal, dexVal);
    const currentDps = current.dps;
    const currentEff = current.effScore;

    // ê°€ìƒ ë°°ë¶„ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ê¸°ì¤€ ë°ì´í„° ì €ì¥
    window._statBaseData = {
        baseAtk,
        baseCrit,
        baseEvade,
        totalStat,
        currentEff,
        currentDps,
        currentEvadeApplied: current.evadeApplied
    };

    // ë”œ+ìƒì¡´ ê· í˜• ê¸°ì¤€ ìµœì  íƒìƒ‰
    let bestEff      = -Infinity;
    let bestEffDex   = dexVal;
    let bestEffData  = null;

    const totalInt = Math.round(totalStat);
    for(let d=0; d<=totalInt; d++){
        const STR_new = totalStat - d;
        const res = calcAll(STR_new, d);
        if(res.effScore > bestEff){
            bestEff     = res.effScore;
            bestEffDex  = d;
            bestEffData = res;
        }
    }

    const bestEffStr = totalStat - bestEffDex;
    const diffEffPercent = ((bestEff / currentEff) - 1) * 100;
    const diffEffRounded = Math.round(diffEffPercent * 10) / 10;

    // í¬ì¸íŠ¸ë‹¹ STR / DEX ë”œ íš¨ìœ¨ & íšŒí”¼ íš¨ìœ¨ (í˜„ì¬ ìœ„ì¹˜ ê¸°ì¤€)
    const multCritNow = avgMultiplierFromCrit(critVal);
    const deltaDStr   = 0.35 * multCritNow; // STR 1 â†’ ê³µê²©ë ¥ +0.35

    const multCritDex = avgMultiplierFromCrit(critVal + 0.18);
    const deltaDDex   = atkVal * (multCritDex - multCritNow);

    const evBefore = evadeVal;
    const evAfter  = evadeVal + 0.18;

    const appliedBefore = appliedEvade(evBefore);
    const appliedAfter  = appliedEvade(evAfter);
    const diffApplied   = appliedAfter - appliedBefore;

    const evBeforeStr  = isFinite(appliedBefore) ? appliedBefore.toFixed(2) : "0.00";
    const evAfterStr   = isFinite(appliedAfter)  ? appliedAfter.toFixed(2)  : "0.00";
    const evDiffStr    = isFinite(diffApplied)   ? diffApplied.toFixed(3)   : "0.000";

    let ratioText = "";
    if(deltaDDex > 0){
        const ratio = deltaDStr / deltaDDex;
        const ratioRound = Math.round(ratio * 10) / 10;
        ratioText = `(í˜„ì¬ ê¸°ì¤€ STR 1í¬ì¸íŠ¸ê°€ DEX 1í¬ì¸íŠ¸ë³´ë‹¤ ì•½ <b>${ratioRound}</b>ë°° ì •ë„ ë”œ íš¨ìœ¨ì´ ë†’ìŠµë‹ˆë‹¤.)`;
    }

    // ì…ë ¥ê°’ ì €ì¥
    saveStatInputs(strVal, dexVal, atkVal, critVal, evadeVal);

    // ê²°ê³¼ ì¶œë ¥
    let msg = "";

    // í˜„ì¬ ìƒíƒœ
    msg += `<b>í˜„ì¬ ë°°ë¶„</b><br>`;
    msg += `STR: <b>${strVal}</b>, DEX: <b>${dexVal}</b><br>`;
    msg += `í‰ê·  ë”œ: ì•½ <b>${currentDps.toFixed(2)}</b><br>`;
    msg += `ì‹¤ì œ ì ìš© íšŒí”¼: ì•½ <b>${current.evadeApplied.toFixed(2)}%</b><br><br>`;

    // í¬ì¸íŠ¸ë‹¹ íš¨ìœ¨
    msg += `<b>í¬ì¸íŠ¸ë‹¹ íš¨ìœ¨ (í˜„ì¬ ìŠ¤íƒ¯ ê¸°ì¤€)</b><br>`;
    msg += `STR 1 ì°ìœ¼ë©´: í‰ê·  ë”œ ì•½ <b>${deltaDStr.toFixed(3)}</b> ì¦ê°€<br>`;
    msg += `DEX 1 ì°ìœ¼ë©´: í‰ê·  ë”œ ì•½ <b>${deltaDDex.toFixed(3)}</b> ì¦ê°€<br>`;
    msg += ratioText ? (ratioText + "<br><br>") : "<br>";

    // DEX 1í¬ì¸íŠ¸ íšŒí”¼ íš¨ìœ¨
    msg += `<b>DEX 1í¬ì¸íŠ¸ì˜ íšŒí”¼ íš¨ìœ¨</b><br>`;
    msg += `í‘œê¸° íšŒí”¼ ìˆ˜ì¹˜: <b>${evBefore.toFixed(2)} â†’ ${evAfter.toFixed(2)}</b> ( +0.18 )<br>`;
    msg += `ì‹¤ì œ ì ìš© íšŒí”¼: <b>${evBeforeStr}% â†’ ${evAfterStr}%</b><br>`;
    msg += `â‡’ ì‹¤ì œë¡œëŠ” ì•½ <b>${evDiffStr}%p</b> ì •ë„ë§Œ íšŒí”¼ê°€ ëŠ˜ì–´ë‚©ë‹ˆë‹¤.<br><br>`;

    // ë”œ+ìƒì¡´ ê· í˜• ê¸°ì¤€ ìµœì  ë°°ë¶„
    msg += `<b>ë”œ + ìƒì¡´(íšŒí”¼) ê· í˜• ê¸°ì¤€ ìµœì  ë°°ë¶„</b><br>`;
    msg += `ì¶”ì²œ ë°°ë¶„: DEX <b>${bestEffDex}</b>, STR <b>${bestEffStr}</b><br>`;
    msg += `ì˜ˆìƒ í‰ê·  ë”œ: ì•½ <b>${bestEffData.dps.toFixed(2)}</b><br>`;
    msg += `ì¶”ì²œ ë¶„ë°° ì‹œ ìµœì¢… ê³µê²©ë ¥: ì•½ <b>${bestEffData.atk.toFixed(2)}</b><br>`;
    msg += `ì¶”ì²œ ë¶„ë°° ì‹œ ìµœì¢… íšŒí”¼ ìˆ˜ì¹˜(X): <b>${bestEffData.evStat.toFixed(2)}</b><br>`;
    msg += `ì¶”ì²œ ë¶„ë°° ì‹œ ì‹¤ì œ íšŒí”¼: ì•½ <b>${bestEffData.evadeApplied.toFixed(2)}%</b><br>`;
    msg += `í˜„ì¬ ëŒ€ë¹„ ì´ íš¨ìœ¨(DPSÃ—ìƒì¡´) ë³€í™”: <b>${diffEffRounded}%</b>${diffEffRounded > 0 ? " ì¦ê°€" : (diffEffRounded < 0 ? " ê°ì†Œ" : " ë³€í™” ì—†ìŒ")}<br><br>`;

    // ê°€ìƒ ìŠ¤íƒ¯ ë°°ë¶„ í…ŒìŠ¤íŠ¸ UI
    msg += `<hr><b>ê°€ìƒ ìŠ¤íƒ¯ ë°°ë¶„ í…ŒìŠ¤íŠ¸</b><br>`;
    msg += `ì–´ë””ê¹Œì§€ë‚˜ ì •ë‹µì€ ì—†ê³ , ì²´ê°ìƒ ì‹¤ íšŒí”¼ìœ¨ 50%ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í•©ë‹ˆë‹¤.<br>`;
    msg += `ì•„ë˜ STR / DEX ê°’ì„ ìˆ˜ì •í•´ ë³´ë©°, ê°€ìƒ ë°°ë¶„ íš¨ìœ¨ì„ í™•ì¸í•´ ë³´ì„¸ìš”.<br>`;
    msg += `STR: <input type="number" id="statHypoStr" value="${bestEffStr}" style="width:80px"> `;
    msg += `DEX: <input type="number" id="statHypoDex" value="${bestEffDex}" style="width:80px"> `;
    msg += `<button type="button" onclick="runCustomStatTest()">ê°€ìƒ ë°°ë¶„ ê³„ì‚°</button><br>`;
    msg += `<div id="statHypoResult" style="margin-top:8px;"></div><br>`;
    msg += `<small>â€» ì´ ê³„ì‚°ê¸°ëŠ” <b>ë”œ(ê³µê²©ë ¥Ã—ì¹˜ëª…)</b>ê³¼ íšŒí”¼ ê³µì‹(íšŒí”¼/(íšŒí”¼+100))ì„ í•¨ê»˜ ì‚¬ìš©í•´, ëª¬ìŠ¤í„° ëª…ì¤‘ë¥ ì„ 100%ë¡œ ê°€ì •í•œ ìƒëŒ€ì ì¸ "ë”œÃ—ìƒì¡´" íš¨ìœ¨ì´ ìµœëŒ€ê°€ ë˜ëŠ” STR/DEX ë°°ë¶„ì„ ì°¾ìŠµë‹ˆë‹¤. CONì€ ê³„ì‚°ì—ì„œ ì œì™¸í–ˆìŠµë‹ˆë‹¤.</small>`;

    out.innerHTML = msg;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
   ì´ˆê¸° ì‹¤í–‰
   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
window.addEventListener("load", ()=>{
    applyDarkModeFromStorage();
    applyRetroFromStorage();
    updateBoxProb();
    initUpgradeSelects();
    updateUpgradeStatsDisplay();
    updateUpgradeProb();
    loadStatInputs();
    updateTotalCostTargetOptions();
    const partSel = document.getElementById("tc_part");
    if(partSel){
        partSel.addEventListener("change", updateTotalCostTargetOptions);
    }
});
</script>

</body>
</html>
