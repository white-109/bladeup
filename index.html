<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>도전검 키우기 도구 모음</title>
    <style>
        body{
            font-family: Arial, sans-serif;
            background:#eef2ff;
            padding:30px;
            margin:0;
            color:#111827;
        }

        /* 다크모드 토글 */
        .dark-toggle{
            max-width:1250px;
            margin:10px auto 0;
            display:flex;
            justify-content:flex-end;
            align-items:center;
            font-size:13px;
            color:#555;
        }
        .dark-toggle label{
            display:flex;
            align-items:center;
            gap:6px;
            cursor:pointer;
            font-weight:normal;
            margin:0;
        }
        .dark-toggle input[type="checkbox"]{
            width:18px;
            height:18px;
            cursor:pointer;
        }

        /* 상단 우측 제작자 표시 */
        .author-tag{
            position:fixed;
            top:10px;
            right:18px;
            font-size:12px;
            color:#888;
            z-index:100;
            pointer-events:none;
        }

        /* 공통 카드 스타일 */
        .card{
            background:#fff;
            padding:25px;
            border-radius:14px;
            box-shadow:0 4px 10px rgba(0,0,0,0.15);
            margin-bottom:30px;
        }

        /* ===== 상단 영역(리뷰 + 경험치 계산기) ===== */
        .top-area{
            position:relative;
            max-width:1100px;
            margin:20px auto 30px;
            min-height:320px;
        }
        .exp-card{
            width:420px;
            margin:0 auto;
            box-sizing:border-box;
        }
        h2{
            text-align:center;
            margin-bottom:20px;
            color:#333;
        }
        label{
            margin-top:12px;
            font-weight:bold;
            display:block;
            margin-bottom:5px;
        }
        select,input{
            width:100%;
            padding:10px;
            margin-top:6px;
            border:1px solid #bbb;
            border-radius:8px;
            box-sizing:border-box;
        }
        button{
            width:100%;
            margin-top:20px;
            padding:12px;
            background:#4A6CFF;
            border:none;
            color:#fff;
            font-size:16px;
            border-radius:8px;
            cursor:pointer;
        }
        button:hover{
            background:#3a55d8;
        }
        .r{
            margin-top:15px;
            background:#f3f6ff;
            padding:12px;
            border-radius:12px;
            font-size:14px;
            line-height:1.65;
            max-height:220px;
            overflow-y:auto;
            white-space:normal;
            word-wrap:break-word;
        }

        /* 게임 이미지 + 리뷰 버튼 */
        .game-promo{
            position:absolute;
            left:0;
            top:50%;
            transform:translateY(-50%);
            width:260px;
            background:#ffffffaa;
            padding:20px;
            border-radius:14px;
            display:flex;
            flex-direction:column;
            align-items:center;
            box-shadow:0 4px 12px rgba(0,0,0,0.12);
            box-sizing:border-box;
        }
        .game-img{
            width:200px;
            border-radius:12px;
            margin-bottom:15px;
        }
        .review-btn{
            display:inline-block;
            background:#4A6CFF;
            color:#fff;
            font-weight:bold;
            padding:10px 14px;
            border-radius:8px;
            text-decoration:none;
            font-size:14px;
            text-align:center;
            width:100%;
            box-sizing:border-box;
            transition:0.2s;
        }
        .review-btn:hover{
            background:#3a55d8;
        }

        /* ===== 상자 시뮬레이터 ===== */
        .sim-card{
            max-width:1250px;
            margin:0 auto 40px;
            box-sizing:border-box;
        }
        .layout-3col{
            display:flex;
            justify-content:space-between;
            align-items:flex-start;
            gap:20px;
        }
        .left-col,
        .mid-col,
        .right-col{
            width:32%;
            box-sizing:border-box;
        }
        .accumBox{
            background:#fff7e6;
            border-radius:12px;
            padding:12px;
            border:1px solid #ffdf9e;
            font-size:14px;
            line-height:1.6;
            max-height:450px;
            overflow-y:auto;
            white-space:normal;
            margin-bottom:12px;
        }
        .probBox{
            background:#f9fafc;
            border-radius:12px;
            padding:12px;
            font-size:13px;
            line-height:1.6;
            border:1px solid #dde3f5;
            max-height:450px;
            overflow-y:auto;
        }
        .btn-row{
            display:flex;
            gap:8px;
            margin-top:12px;
        }
        .btn-row button{
            flex:1;
            margin-top:0;
        }
        .yellow-highlight{
            background:#ffeb3b;
            padding:0 4px;
            border-radius:4px;
        }

        /* ===== 장비 강화 시뮬레이션 ===== */
        .enh-card{
            max-width:1250px;
            margin:0 auto 40px;
            box-sizing:border-box;
        }
        .enh-layout{
            display:flex;
            gap:20px;
            align-items:flex-start;
            justify-content:space-between;
        }
        .enh-left,
        .enh-main,
        .enh-right{
            width:32%;
            box-sizing:border-box;
        }
        .enh-main{
            min-width:320px;
        }
        .enh-stats-box{
            background:#f9fafc;
            border-radius:12px;
            border:1px solid #dde3f5;
            padding:12px;
            font-size:13px;
            line-height:1.6;
        }
        .enh-prob{
            background:#f9fafc;
            border-radius:12px;
            border:1px solid #dde3f5;
            padding:12px;
            font-size:13px;
            line-height:1.6;
        }
        .enh-row{
            display:flex;
            gap:8px;
            align-items:center;
            margin-top:6px;
            flex-wrap:wrap;
        }
        .enh-row label.inline{
            font-weight:normal;
            margin-top:0;
        }
        .enh-badge{
            display:inline-block;
            padding:2px 6px;
            border-radius:6px;
            background:#e3e8ff;
            font-size:12px;
            margin-left:4px;
        }
        .enh-summary{
            background:#fff;
            border-radius:10px;
            padding:8px 10px;
            margin-bottom:10px;
            border:1px solid #dde3f5;
            font-size:12px;
        }
        .enh-level-title{
            font-weight:bold;
            margin-top:8px;
        }
        .enh-meta{
            font-size:12px;
            color:#555;
        }

        .stat-reset-btn{
            margin-top:8px;
            width:100%;
            padding:8px 10px;
            border-radius:8px;
            border:none;
            background:#4A6CFF;
            font-size:13px;
            cursor:pointer;
            color:#fff;
            font-weight:bold;
        }
        .stat-reset-btn:hover{
            background:#3a55d8;
        }

        /* 강화 로그 색상 */
        .log-entry{
            font-size:13px;
            margin-bottom:4px;
        }
        .log-success{ color:#1b8a3a; }
        .log-keep{ color:#555; }
        .log-down{ color:#d88a00; }
        .log-break{ color:#d33; }
        .log-info{ color:#2b6cb0; }

        .auto-controls{
            display:flex;
            gap:8px;
            margin-top:8px;
            flex-wrap:wrap;
        }
        .auto-controls button{
            flex:1;
            padding:8px 10px;
            margin-top:0;
            font-size:13px;
        }
        .speed-row{
            display:flex;
            align-items:center;
            gap:8px;
            margin-top:8px;
        }
        .speed-row span{
            font-size:13px;
        }

        .small-btn{
            width:auto;
            margin-top:0;
            padding:6px 10px;
            font-size:12px;
        }

        .start-row{
            display:flex;
            align-items:center;
            gap:8px;
            margin-top:6px;
            flex-wrap:wrap;
        }
        .start-row span{
            font-size:13px;
        }
        #enhStartLevel{
            width:auto;
            padding:6px 8px;
        }

        /* 강화 로그: 크기 고정 + JS로 오래된 로그 삭제 */
        #enhLog{
            overflow-y:hidden;
        }

        /* 반응형 */
        @media (max-width: 900px){
            .top-area{
                min-height:0;
            }
            .game-promo{
                position:static;
                transform:none;
                margin:0 auto 20px;
            }
            .layout-3col{
                flex-wrap:wrap;
            }
            .left-col,
            .mid-col,
            .right-col{
                width:100%;
            }
            .enh-layout{
                flex-wrap:wrap;
            }
            .enh-left,
            .enh-main,
            .enh-right{
                width:100%;
            }
        }

        /* ===== 다크 모드 ===== */
        body.dark-mode{
            background:#020617;
            color:#e5e7eb;
        }
        body.dark-mode .card{
            background:#0f172a;
            box-shadow:0 4px 14px rgba(0,0,0,0.5);
        }
        body.dark-mode h2{
            color:#e5e7eb;
        }
        body.dark-mode select,
        body.dark-mode input{
            background:#020617;
            color:#e5e7eb;
            border-color:#4b5563;
        }
        body.dark-mode .r,
        body.dark-mode .accumBox,
        body.dark-mode .probBox,
        body.dark-mode .enh-stats-box,
        body.dark-mode .enh-prob{
            background:#020617;
            border-color:#374151;
            color:#e5e7eb;
        }
        body.dark-mode .game-promo{
            background:#020617dd;
        }
        body.dark-mode .author-tag{
            color:#9ca3af;
        }
        body.dark-mode .review-btn,
        body.dark-mode button,
        body.dark-mode .stat-reset-btn{
            background:#6366f1;
        }
        body.dark-mode .review-btn:hover,
        body.dark-mode button:hover,
        body.dark-mode .stat-reset-btn:hover{
            background:#4f46e5;
        }
		body.dark-mode .yellow-highlight{
    background:#facc15;  /* 노란색 유지 */
    color:#111827;       /* 진한 글자색 */
}

/* 통계 상단 박스(누적 사용 주문서 / 통계 초기화 버튼 있는 부분) */
body.dark-mode .enh-summary{
    background:#020617;   /* 어두운 배경 */
    border-color:#4b5563;
    color:#e5e7eb;        /* 글씨 밝게 */
}

/* "안전강화 구간" 배지 */
body.dark-mode .enh-badge{
    background:#1d4ed8;
    color:#e5e7eb;
}

/* 통계 설명 텍스트 색 조금 더 밝게 */
body.dark-mode .enh-meta{
    color:#d1d5db;
}

    </style>
</head>
<body>

<div class="author-tag">by . Pet(소매치기)</div>

<!-- 다크모드 스위치 -->
<div class="dark-toggle">
    <label>
        <input type="checkbox" id="darkModeToggle">
        다크 모드
    </label>
</div>

<!-- ===== 상단: 리뷰 + 경험치 계산기 ===== -->
<div class="top-area">

    <!-- 리뷰 박스 (왼쪽) -->
    <div class="game-promo">
        <img src="https://play-lh.googleusercontent.com/AHNGFcD7v94xf87iiEpqeFt2L4zmGz3F9LqvGv11BtugY9DenVIdGSoQ4HKV9yZFxlR16gWlo70Xyy4mu0e4FA=w240-h480-rw"
             class="game-img" alt="도전검 키우기">
        <a href="https://play.google.com/store/apps/details?id=com.embris.bladeup"
           target="_blank"
           class="review-btn">
            ⭐ 별 5개 리뷰하러 가기
        </a>
    </div>

    <!-- 경험치 계산기 (중앙) -->
    <div class="card exp-card">
        <h2>경험치 계산기</h2>

        <label>1. 몬스터 경험치 선택</label>
        <select id="a">
            <option value="6000" selected>6000</option>
            <option value="9000">9000</option>
            <option value="12000">12000</option>
            <option value="15000">15000</option>
        </select>

        <label>2. 방패 강화 단계 (5강부터 경험치 증가)</label>
        <select id="b">
            <option value="0" selected>--- 선택 ---</option>
            <option value="5">5강 (10%)</option>
            <option value="6">6강 (20%)</option>
            <option value="7">7강 (30%)</option>
            <option value="8">8강 (40%)</option>
            <option value="9">9강 (50%)</option>
            <option value="10">10강 (60%)</option>
        </select>

        <button onclick="z()">계산하기</button>

        <div class="r" id="x"></div>
    </div>
</div>

<!-- ===== 상자 시뮬레이터 ===== -->
<div class="card sim-card">
    <h2>상자 시뮬레이터 (무기 / 방어구 / 장신구)</h2>

    <div class="layout-3col">

        <!-- LEFT : 누적 결과 -->
        <div class="left-col">
            <label>누적 결과</label>
            <div class="accumBox" id="accumBox">아직 없음</div>
            <button onclick="resetAccum()">누적 초기화</button>
        </div>

        <!-- MID : 시뮬 UI -->
        <div class="mid-col">
            <label>부위 선택</label>
            <select id="partSelect" onchange="onPartChange()">
                <option value="weapon">무기</option>
                <option value="armor">방어구</option>
                <option value="accessory">장신구</option>
            </select>

            <label>상자 등급 선택</label>
            <select id="gradeSelect" onchange="updateProbBox()">
                <option value="D">D 등급 박스</option>
                <option value="C">C 등급 박스</option>
                <option value="B">B 등급 박스</option>
                <option value="A">A 등급 박스</option>
            </select>

            <div class="btn-row">
                <button onclick="openBox(1)">1회</button>
                <button onclick="openBox(10)">10회</button>
                <button onclick="openBox(100)">100회</button>
            </div>

            <div class="r" id="boxResult"></div>
        </div>

        <!-- RIGHT : 확률표 -->
        <div class="right-col">
            <div class="probBox" id="probBox"></div>
        </div>

    </div>
</div>

<!-- ===== 장비 강화 시뮬레이션 ===== -->
<div class="card enh-card">
    <h2>장비 강화 시뮬레이션</h2>

    <div class="enh-layout">

        <!-- LEFT : 통계 -->
        <div class="enh-left">
            <div class="enh-stats-box">
                <div class="enh-summary">
                    누적 사용 주문서 : <b id="statScrolls">0</b> 개<br>
                    누적 사용 장비   : <b id="statItems">0</b> 개
                    <button type="button" class="stat-reset-btn" onclick="resetEnhStats()">통계 초기화</button>
                </div>
                <div id="enhLevelStats">
                    연속강화 시 단계별 통계가 여기에 표시됩니다.
                </div>
            </div>
        </div>

        <!-- CENTER : 강화 UI -->
        <div class="enh-main">
            <label>장비 종류 선택</label>
            <select id="enhTypeSelect">
                <option value="weapon">무기</option>
                <option value="armor">방어구</option>
                <option value="accessory">장신구</option>
            </select>

            <label>현재 강화 단계</label>
            <div class="enh-row">
                <span id="enhCurrentLevel">+0</span>
                <span class="enh-badge" id="enhSafeBadge">안전강화 구간</span>
            </div>

            <!-- 시작 강화 단계 선택 -->
            <div class="start-row">
                <span>시작 강화 단계:</span>
                <select id="enhStartLevel"></select>
                <button type="button" class="small-btn" onclick="applyStartLevel()">적용</button>
            </div>

            <label>성공 / 실패 정보</label>
            <div class="enh-row">
                <span class="enh-meta">
                    성공 확률: <b id="enhSuccessRate">100%</b><br>
                    실패 시: 유지 / 하락 / 파괴 (각 33%)
                </span>
            </div>

            <button onclick="doSingleEnhance()">강화하기</button>

            <div style="margin-top:15px; border-top:1px solid #e0e4ff; padding-top:10px;">
                <label class="inline">
                    <input type="checkbox" id="enhAutoCheck" onchange="onAutoToggle()">
                    연속강화 사용
                </label>

                <div id="autoOptions" style="margin-top:10px; display:none;">
                    <label>목표 강화 단계 선택</label>
                    <select id="enhTargetLevel"></select>

                    <div class="speed-row">
                        <span>속도:</span>
                        <select id="enhSpeed">
                            <option value="2">중간</option>
                            <option value="4">빠름</option>
                            <option value="8">매우 빠름</option>
                        </select>
                    </div>

                    <div class="auto-controls">
                        <button type="button" onclick="doAutoEnhance()">연속강화 시작</button>
                        <button type="button" onclick="stopAutoEnhance()">강화 중지</button>
                    </div>
                </div>
            </div>

            <div class="r" id="enhLog" style="margin-top:15px;">
                <div class="log-entry log-info">강화 로그가 여기 표시됩니다.</div>
            </div>
        </div>

        <!-- RIGHT : 강화 확률표 -->
        <div class="enh-right">
            <div class="enh-prob" id="enhProbBox">
                강화 확률표가 여기에 표시됩니다.
            </div>
        </div>

    </div>
</div>

<script>
/* ========== 다크 모드 토글 ========== */
(function initDarkMode(){
    const toggle = document.getElementById('darkModeToggle');
    const saved = localStorage.getItem('bladeup_dark_mode');
    if(saved === '1'){
        document.body.classList.add('dark-mode');
        toggle.checked = true;
    }
    toggle.addEventListener('change', (e)=>{
        if(e.target.checked){
            document.body.classList.add('dark-mode');
            localStorage.setItem('bladeup_dark_mode','1');
        }else{
            document.body.classList.remove('dark-mode');
            localStorage.setItem('bladeup_dark_mode','0');
        }
    });
})();

/* ========== 경험치 계산기 ========== */
function y(q){
    let w = q * 100;
    if (w < 0.0001) return "0%";
    return Number.isInteger(w) ? w + "%" : w.toFixed(1) + "%";
}
function z(){
    let m = Number(document.getElementById("a").value); // 표기 경험치
    let n = Number(document.getElementById("b").value); // 방패 강화 단계

    if (n === 0) {
        document.getElementById("x").innerHTML = "강화 단계를 선택해주세요.";
        return;
    }

    let o = m / 1.5; // 원경험치(Base EXP)
    let p = (n - 4) * 0.1;
    if (p < 0) p = 0;
    let r = 1 + 0.5 + p; // 1 + PK(0.5) + 장비보너스
    let s = Math.floor(o * r);

    document.getElementById("x").innerHTML =
        "<b>최종 계산 결과</b><br>" +
        "선택 몬스터 경험치(표기): <b>" + m + "</b><br>" +
        "원경험치(Base EXP): <b>" + o.toFixed(0) + "</b><br>" +
        "장비 경험치 보너스: <b>" + y(p) + "</b><br>" +
        "PK존 보너스: <b>50%</b><br><br>" +
        ">> <b>획득 경험치: " + s + "</b><br><br>" +
        "<b>경험치 공식</b><br>" +
        "표기 경험치 = 원경험치 × 1.5 (PK 50% 포함)<br>" +
        "최종 경험치 = 원경험치 × (1 + PK + 장비보너스)<br>" +
        "= 원경험치 × (1 + 0.5 + 장비%)<br>" +
        "= 원경험치 × " + r.toFixed(2);
}

/* ========== 상자 시뮬레이터 ========== */
const weaponRates = {
    "D": {
        "X+":0.000100,"X":0.000200,"SSS+":0.000500,"SSS":0.000800,"SS+":0.001000,"SS":0.002000,
        "S+":0.010000,"S":0.015000,"A+":0.030000,"A":0.050000,"B":0.070000,"C":0.090000,
        "D":0.111200,"E":0.223200,"F":0.396000
    },
    "C": {
        "X+":0.000200,"X":0.000500,"SSS+":0.001000,"SSS":0.002000,"SS+":0.003000,"SS":0.004000,
        "S+":0.020000,"S":0.025000,"A+":0.050000,"A":0.070000,"B":0.090000,"C":0.100000,
        "D":0.148800,"E":0.173200,"F":0.312300
    },
    "B": {
        "X+":0.005000,"X":0.010000,"SSS+":0.013000,"SSS":0.016000,"SS+":0.020000,"SS":0.021000,
        "S+":0.048500,"S":0.062300,"A+":0.112100,"A":0.123100,"B":0.082200,"C":0.092000,
        "D":0.101400,"E":0.112300,"F":0.181100
    },
    "A": {
        "X+":0.015000,"X":0.023000,"SSS+":0.030000,"SSS":0.032000,"SS+":0.042000,"SS":0.052100,
        "S+":0.108500,"S":0.142300,"A+":0.101100,"A":0.113200,"B":0.097200,"C":0.056300,
        "D":0.053200,"E":0.072100,"F":0.062000
    }
};
const armorRates = {
    "D": {
        "X":0.0001,"SSS":0.0005,"SS":0.0010,"S":0.0030,"A":0.0130,
        "B":0.0320,"C":0.0818,"D":0.1721,"E":0.3212,"F":0.3753
    },
    "C": {
        "X":0.0005,"SSS":0.0030,"SS":0.0030,"S":0.0080,"A":0.0292,
        "B":0.0920,"C":0.1232,"D":0.2167,"E":0.2123,"F":0.3121
    },
    "B": {
        "X":0.0050,"SSS":0.0100,"SS":0.0130,"S":0.0350,"A":0.0750,
        "B":0.1540,"C":0.1572,"D":0.1523,"E":0.1752,"F":0.2233
    },
    "A": {
        "X":0.0150,"SSS":0.0230,"SS":0.0450,"S":0.0923,"A":0.1962,
        "B":0.1802,"C":0.1213,"D":0.1079,"E":0.1120,"F":0.1071
    }
};
const accessoryRates = {
    "D": {
        "X":0.0001,"S":0.0010,"A":0.0030,"B":0.0240,"C":0.1003,
        "D":0.1602,"E":0.3002,"F":0.4112
    },
    "C": {
        "X":0.0005,"S":0.0015,"A":0.0100,"B":0.0432,"C":0.1552,
        "D":0.2443,"E":0.2232,"F":0.3221
    },
    "B": {
        "X":0.0050,"S":0.0100,"A":0.0250,"B":0.1211,"C":0.1732,
        "D":0.1922,"E":0.2121,"F":0.2614
    },
    "A": {
        "X":0.0150,"S":0.0230,"A":0.0480,"B":0.2221,"C":0.1896,
        "D":0.1632,"E":0.1821,"F":0.1570
    }
};

const ratesByPart = {
    weapon: weaponRates,
    armor: armorRates,
    accessory: accessoryRates
};
const gradeOrders = {
    weapon: ["X+","X","SSS+","SSS","SS+","SS","S+","S","A+","A","B","C","D","E","F"],
    armor:  ["X","SSS","SS","S","A","B","C","D","E","F"],
    accessory: ["X","S","A","B","C","D","E","F"]
};
const partLabel = {
    weapon: "무기",
    armor: "방어구",
    accessory: "장신구"
};
let accum = {};
let boxCount = { D:0, C:0, B:0, A:0 };

function highlight(item){
    if(item==="X+" || item==="X"){
        return `<span class="yellow-highlight"><b>${item}</b></span>`;
    }
    return `<b>${item}</b>`;
}
function formatPercent(v){
    return (v*100).toFixed(3).replace(/0+$/,"").replace(/\.$/,"") + "%";
}
function getCurrentPart(){
    return document.getElementById("partSelect").value;
}
function getCurrentGrade(){
    return document.getElementById("gradeSelect").value;
}
function onPartChange(){
    resetAccum();
    updateProbBox();
    document.getElementById("boxResult").innerHTML = "";
}
function openBox(times){
    const part  = getCurrentPart();
    const grade = getCurrentGrade();
    const table = ratesByPart[part][grade];

    const entries = Object.entries(table);
    const totalProb = entries.reduce((sum, [,v]) => sum + v, 0);
    const results = [];

    for(let i=0;i<times;i++){
        let r = Math.random() * totalProb;
        let sum = 0;
        for(let [it, p] of entries){
            sum += p;
            if(r <= sum){
                results.push(it);
                break;
            }
        }
    }
    updateInstant(results, part);
    updateAccum(results, grade, part, times);
}
function updateInstant(arr, part){
    const order = gradeOrders[part];
    let count = {};
    arr.forEach(v=>{
        if(!count[v]) count[v]=0;
        count[v]++;
    });

    let html = "<b>이번 결과</b><br><br>";
    const specials = [];
    if(order.includes("X+")) specials.push("X+");
    if(order.includes("X"))  specials.push("X");

    specials.forEach(g=>{
        if(count[g]) html += `${highlight(g)} : ${count[g]}개<br>`;
    });
    if (specials.some(g=>count[g])) html += "<br>";

    let line = "";
    order.filter(g=>!specials.includes(g)).forEach(g=>{
        if(count[g]) line += `${highlight(g)}:${count[g]}개 `;
    });

    html += line.trim();
    document.getElementById("boxResult").innerHTML = html;
}
function updateAccum(arr, grade, part, times){
    const order = gradeOrders[part];
    arr.forEach(v=>{
        if(!accum[v]) accum[v]=0;
        accum[v]++;
    });
    boxCount[grade] += times;

    let html = "<b>누적 결과</b><br><br>";
    html += "<b>누적 깐 상자 수</b><br>";
    html += `D : ${boxCount.D}개&nbsp;&nbsp;`;
    html += `C : ${boxCount.C}개&nbsp;&nbsp;`;
    html += `B : ${boxCount.B}개&nbsp;&nbsp;`;
    html += `A : ${boxCount.A}개<br><br>`;

    const specials = [];
    if(order.includes("X+")) specials.push("X+");
    if(order.includes("X"))  specials.push("X");

    specials.forEach(g=>{
        if(accum[g]) html += `${highlight(g)} : ${accum[g]}개<br>`;
    });
    if (specials.some(g=>accum[g])) html += "<br>";

    let line = "";
    order.filter(g=>!specials.includes(g)).forEach(g=>{
        if(accum[g]) line += `${highlight(g)}:${accum[g]}개 `;
    });
    if(line==="") line = "아직 없음";

    html += line.trim();
    document.getElementById("accumBox").innerHTML = html;
}
function resetAccum(){
    accum = {};
    boxCount = { D:0, C:0, B:0, A:0 };
    document.getElementById("accumBox").innerHTML = "아직 없음";
}
function updateProbBox(){
    const part  = getCurrentPart();
    const grade = getCurrentGrade();
    const table = ratesByPart[part][grade];
    const order = gradeOrders[part];

    let html = `<b>[${partLabel[part]} ${grade} 등급 상자 확률]</b><br><br>`;
    const specials = [];
    if(order.includes("X+")) specials.push("X+");
    if(order.includes("X"))  specials.push("X");

    specials.forEach(g=>{
        if(table[g] !== undefined){
            html += `${highlight(g)} : ${formatPercent(table[g])}<br>`;
        }
    });
    if (specials.some(g => table[g] !== undefined)) html += "<br>";

    order.filter(g=>!specials.includes(g)).forEach(g=>{
        if(table[g] !== undefined){
            html += `${highlight(g)} : ${formatPercent(table[g])}<br>`;
        }
    });
    document.getElementById("probBox").innerHTML = html;
}
updateProbBox();

/* ========== 장비 강화 시뮬레이션 ========== */
/* 안전강화: 0~(safeTo-1)까지 100%, safeTo→safeTo+1부터 위험 */
const safeToByType = {
    weapon: 6,   // 6강까지 안전 (0~5)
    armor: 4,    // 4강까지 안전 (0~3)
    accessory: 3 // 3강까지 안전 (0~2)
};

/* 최대 강화 단계 */
const maxEnhByType = {
    weapon: 15,
    armor: 10,
    accessory: 8
};

/* 실제 성공확률 테이블 (현재단계 → 다음단계 성공률) */
const successRates = {
    weapon: {
        6: 0.60,
        7: 0.50,
        8: 0.40,
        9: 0.30,
        10: 0.25,
        11: 0.20,
        12: 0.15,
        13: 0.10,
        14: 0.05
    },
    armor: {
        4: 0.40,
        5: 0.30,
        6: 0.20,
        7: 0.15,
        8: 0.10,
        9: 0.05
    },
    accessory: {
        3: 0.33,
        4: 0.20,
        5: 0.13,
        6: 0.07,
        7: 0.03
    }
};

let enhCurrentType = "weapon";
let enhCurrentLevel = 0;
let enhStats = {
    scrolls: 0,
    items: 0,
    perLevel: {}
};

let autoTimer = null;
let autoTargetLevel = 0;
let autoLoopGuard = 0;
const AUTO_MAX_LOOP = 200000;
const LOG_MAX_LINES = 80;

function getSuccessRate(type, level){
    const safeTo = safeToByType[type];
    const maxLv = maxEnhByType[type];

    if(level >= maxLv) return 0;
    if(level < safeTo) return 1.0;

    const table = successRates[type] || {};
    if(table[level] !== undefined){
        return table[level];
    }
    return 0.01;
}

function ensureLevelStat(level){
    if(!enhStats.perLevel[level]){
        enhStats.perLevel[level] = {
            success:0,
            keep:0,
            down:0,
            broke:0
        };
    }
}

function appendEnhLog(message, type){
    const logBox = document.getElementById("enhLog");
    const div = document.createElement("div");
    div.className = "log-entry" + (type ? " log-" + type : "");
    div.innerHTML = message;

    if(logBox.firstChild){
        logBox.insertBefore(div, logBox.firstChild);
    }else{
        logBox.appendChild(div);
    }

    while(logBox.children.length > LOG_MAX_LINES){
        logBox.removeChild(logBox.lastChild);
    }
}

function updateEnhDisplay(){
    document.getElementById("enhCurrentLevel").textContent = "+" + enhCurrentLevel;
    const successRate = getSuccessRate(enhCurrentType, enhCurrentLevel);
    document.getElementById("enhSuccessRate").textContent = Math.round(successRate*100) + "%";

    const safeTo = safeToByType[enhCurrentType];
    const badge = document.getElementById("enhSafeBadge");
    if(enhCurrentLevel < safeTo){
        badge.style.display = "inline-block";
        badge.textContent = "안전강화 구간";
    }else{
        badge.style.display = "inline-block";
        badge.textContent = "파괴/하락 가능 구간";
    }

    document.getElementById("statScrolls").textContent = enhStats.scrolls;
    document.getElementById("statItems").textContent = enhStats.items;

    const safeStart = safeToByType[enhCurrentType];
    const container = document.getElementById("enhLevelStats");
    const levels = Object.keys(enhStats.perLevel)
        .map(x=>parseInt(x,10))
        .filter(l => l >= safeStart)
        .sort((a,b)=>a-b);

    if(levels.length === 0){
        container.textContent = "연속강화 시 단계별 통계가 여기에 표시됩니다.";
    } else {
        let html = "";
        levels.forEach(l=>{
            const st = enhStats.perLevel[l];
            html += `<div class="enh-level-title">${l}강</div>`;
            html += `<div class="enh-meta">성공 : ${st.success}회 / 유지 : ${st.keep}회 / 하락 : ${st.down}회 / 파괴 : ${st.broke}회</div>`;
        });
        container.innerHTML = html;
    }

    updateEnhProbBox();
}

function updateEnhProbBox(){
    const box = document.getElementById("enhProbBox");
    const type = enhCurrentType;
    const safeTo = safeToByType[type];
    const maxLv = maxEnhByType[type];

    let label = (type === "weapon") ? "무기" : (type === "armor" ? "방어구" : "장신구");
    let html = `<b>[${label} 강화 확률]</b><br><br>`;

    for(let lv=0; lv<maxLv; lv++){
        const next = lv+1;
        let rate;
        if(lv < safeTo){
            rate = 1.0;
        }else{
            const table = successRates[type] || {};
            rate = table[lv];
            if(rate === undefined) rate = 0.01;
        }
        let pct = Math.round(rate*10000)/100;
        html += `${lv}강 → ${next}강 : <b>${pct}%</b>`;
        if(lv < safeTo) html += " (안전강화)";
        html += "<br>";
    }
    box.innerHTML = html;
}

function populateStartLevelOptions(){
    const sel = document.getElementById("enhStartLevel");
    sel.innerHTML = "";
    const maxLv = maxEnhByType[enhCurrentType];
    for(let lv=0; lv<=maxLv; lv++){
        const opt = document.createElement("option");
        opt.value = lv;
        opt.textContent = lv + "강";
        if(lv === enhCurrentLevel) opt.selected = true;
        sel.appendChild(opt);
    }
}

function applyStartLevel(){
    const sel = document.getElementById("enhStartLevel");
    const lv = Number(sel.value);
    const maxLv = maxEnhByType[enhCurrentType];
    const clamped = Math.max(0, Math.min(maxLv, lv));
    enhCurrentLevel = clamped;
    appendEnhLog(`시작 강화 단계를 +${clamped}로 설정했습니다.`, "info");
    populateStartLevelOptions();
    populateTargetLevelOptions();
    updateEnhDisplay();
}

function doSingleEnhance(logSilent){
    const prevLevel = enhCurrentLevel;
    const type = enhCurrentType;
    const maxLv = maxEnhByType[type];
    const safeTo = safeToByType[type];

    if(prevLevel >= maxLv){
        if(!logSilent){
            appendEnhLog(`이미 최대 강화 단계(+${maxLv})입니다.`, "info");
        }
        return;
    }

    enhStats.scrolls++;

    const successRate = getSuccessRate(type, prevLevel);
    const r = Math.random();
    let resultText = "";
    let resultType = "info";

    if(r < successRate){
        if(enhCurrentLevel < maxLv){
            enhCurrentLevel++;
        }
        resultText = `+${prevLevel} → <b>강화 성공</b> → +${enhCurrentLevel}`;
        if(prevLevel >= safeTo){
            ensureLevelStat(prevLevel);
            enhStats.perLevel[prevLevel].success++;
        }
        resultType = "success";
    }else{
        if(prevLevel < safeTo){
            resultText = `+${prevLevel} → 실패 (안전구간, 단계 유지)`;
            resultType = "keep";
        }else{
            const r2 = Math.random();
            ensureLevelStat(prevLevel);
            if(r2 < 1/3){
                resultText = `+${prevLevel} → 실패 (단계 유지)`;
                enhStats.perLevel[prevLevel].keep++;
                resultType = "keep";
            }else if(r2 < 2/3){
                enhCurrentLevel = Math.max(0, enhCurrentLevel - 1);
                resultText = `+${prevLevel} → 실패 (<b>하락</b>) → +${enhCurrentLevel}`;
                enhStats.perLevel[prevLevel].down++;
                resultType = "down";
            }else{
                enhStats.items++;
                enhCurrentLevel = 0;
                resultText = `+${prevLevel} → 실패 (<b>파괴</b>) → 장비 파괴, +0부터 다시`;
                enhStats.perLevel[prevLevel].broke++;
                resultType = "break";
            }
        }
    }

    if(!logSilent){
        appendEnhLog(resultText, resultType);
    }
    updateEnhDisplay();
}

function onAutoToggle(){
    const chk = document.getElementById("enhAutoCheck").checked;
    document.getElementById("autoOptions").style.display = chk ? "block" : "none";

    if(!chk && autoTimer){
        clearInterval(autoTimer);
        autoTimer = null;
        appendEnhLog("연속강화를 중단했습니다.", "info");
    }
}

function doAutoEnhance(){
    if(!document.getElementById("enhAutoCheck").checked) return;

    const target = Number(document.getElementById("enhTargetLevel").value);
    const maxLv = maxEnhByType[enhCurrentType];
    const speed = Number(document.getElementById("enhSpeed").value) || 2;

    autoTargetLevel = Math.min(target, maxLv);

    if(autoTargetLevel <= enhCurrentLevel){
        appendEnhLog(`이미 +${autoTargetLevel} 이상입니다.`, "info");
        return;
    }

    if(autoTimer){
        clearInterval(autoTimer);
        autoTimer = null;
    }

    autoLoopGuard = 0;

    const baseDelay = 40;
    const delay = Math.max(3, baseDelay / speed);

    autoTimer = setInterval(()=>{
        autoLoopGuard++;
        if(autoLoopGuard > AUTO_MAX_LOOP){
            clearInterval(autoTimer);
            autoTimer = null;
            appendEnhLog("연속강화가 너무 오래 걸려 중단되었습니다. (보호장치 발동)", "info");
            updateEnhDisplay();
            return;
        }

        const maxLvNow = maxEnhByType[enhCurrentType];

        if(enhCurrentLevel >= autoTargetLevel || enhCurrentLevel >= maxLvNow){
            clearInterval(autoTimer);
            autoTimer = null;
            appendEnhLog(`연속강화 종료 : 최종 +${enhCurrentLevel} 도달 (목표 +${autoTargetLevel})`, "info");
            updateEnhDisplay();
            return;
        }

        doSingleEnhance(false);
    }, delay);
}

function stopAutoEnhance(){
    if(autoTimer){
        clearInterval(autoTimer);
        autoTimer = null;
        appendEnhLog("연속강화를 중지했습니다.", "info");
        updateEnhDisplay();
    }
}

function resetEnhStats(){
    enhStats = { scrolls:0, items:0, perLevel:{} };
    appendEnhLog("강화 통계를 초기화했습니다.", "info");
    updateEnhDisplay();
}

document.getElementById("enhTypeSelect").addEventListener("change", (e)=>{
    enhCurrentType = e.target.value;
    enhCurrentLevel = 0;
    appendEnhLog("장비 종류를 변경했습니다.", "info");
    populateStartLevelOptions();
    populateTargetLevelOptions();
    updateEnhDisplay();
});

function populateTargetLevelOptions(){
    const sel = document.getElementById("enhTargetLevel");
    sel.innerHTML = "";
    const maxLv = maxEnhByType[enhCurrentType];
    for(let lv=1; lv<=maxLv; lv++){
        const opt = document.createElement("option");
        opt.value = lv;
        opt.textContent = lv + "강";
        if(lv === maxLv) opt.selected = true;
        sel.appendChild(opt);
    }
}

(function initEnh(){
    populateStartLevelOptions();
    populateTargetLevelOptions();
    updateEnhDisplay();
})();
</script>

</body>
</html>
